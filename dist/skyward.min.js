function rainbow(a,b){var c,d,e,f=b/a,g=~~(6*f),h=6*f-g,i=1-h;switch(g%6){case 0:c=1,d=h,e=0;break;case 1:c=i,d=1,e=0;break;case 2:c=0,d=1,e=h;break;case 3:c=0,d=i,e=1;break;case 4:c=h,d=0,e=1;break;case 5:c=1,d=0,e=i}var j="#"+("00"+(~~(255*c)).toString(16)).slice(-2)+("00"+(~~(255*d)).toString(16)).slice(-2)+("00"+(~~(255*e)).toString(16)).slice(-2);return j}function getData(a,b){var c=10>a?"0"+a.toString():a.toString();return cache[b+a]?init(cache[b+a]):($("body").addClass("loading"),void $.ajax({url:SOURCEURL,data:{m:c,callsign:b},method:"GET",dataType:"JSON",success:init,error:function(a,b){console.log(a,b)}}))}function init(a){var b=$("body");b.removeClass("loading");var c=a[0].callsign+a[0].month;cache[c]=a,chart=new ASOS_Chart(a)}function ASOS_Chart(a){function b(a){for(var b=0;b<a.length;b++){var f=new c(a[b]);e.ids[f.id]=f;var g=f.datestr;e.julians[g]||(e.julians[g]=new d),e.julians[g].add(f)}e.date=e.ids[1].date}function c(a){for(var b in a)this[b]=a[b];return this.x=m,this.y=n,this.date=new Date(this.date),this.setCoordinates=function(){if(this.prev){var a=this.getPrev(),b=projectPoint([a.x,a.y],a.windSpeed/h,a.windDir);this.setPt(b[0],b[1])}return this.getPt()},this.getPt=function(){return[this.x,this.y]},this.setPt=function(a,b){return this.x=a,this.y=b,b>j&&(j=b),a>i&&(i=a),l>b&&(l=b),k>a&&(k=a),this.getPt()},this.getPrev=function(){return this.prev?e.ids[this.prev]:!1},this.scaleX=function(a){return this.x=a(this.x)},this.scaleY=function(a){return this.y=a(this.y)},this}function d(a){var b=a||[];return this.resetOrigin=function(a){var c=b[0].getPrev();return c&&c.setPt(a[0],a[1]),this.setCoordinates(),b.pop(),!0},this.setCoordinates=function(){for(var a=0;a<b.length;a++)b[a].setCoordinates()},this.scaleData=function(a,c){for(var d=0;d<b.length;d++)b[d].scaleX(a),b[d].scaleY(c)},this.getDate=function(){return b[0].date},this.getLast=function(){return b[b.length-2]},this.add=function(a){return b.push(a)},this.getIndex=function(){return b},this.length=function(){return b.length},this}var e=this,f=$("#chart"),g=d3.select("#chart"),h=9,i=0,j=0,k=0,l=0;this.vpW=f.width(),this.vpH=f.height();{var m=.1*this.vpW,n=this.vpH/2,o=(this.vpW-2*m)/30;d3.scale.linear().range([0,this.vpW]),d3.scale.linear().range([0,this.vpH])}this.date,this.getMax=function(){return[i,j]},this.getMin=function(){return[k,l]},this.clear=function(){return g.select("svg").remove(),!0},this.julians={},this.ids=[],this.line=d3.svg.line().x(function(a){return a.x}).y(function(a){return a.y}).interpolate("basis"),this.mapData=function(){var a={},b=0;for(var c in this.julians){var d=this.julians[c],e=[b*o+m,n];d.resetOrigin(e),a[c]={day:b,color:rainbow(31,b),origin:e,data:d},b++}return a},this.draw=function(a){this.clear();var b=g.append("svg"),c=d3.scale.linear().range([1,30]).domain([0,1e3]),d=function(){var d=d3.select(this).attr("id"),e=a[d].data.getLast(),f=a[d].length;b.append("circle").attr("cx",e.x).attr("cy",e.y).attr("r",c(f)).attr("fill",a[d].color)};b.append("text").text(e.date.getMonthName()).attr("x",m-15).attr("y",n-35).attr("dy","0.5em").attr("fill","white").attr("font-weight","700"),Line(b,[m,n],[m+30*o,n],"gray",1);for(var f in a){var h=a[f],i=b.append("g"),j=i.append("path").attr("id",f).attr("d",this.line(h.data.getIndex())).attr("stroke",h.color).attr("stroke-width",2).attr("fill","none"),k=j.node().getTotalLength();j.attr("stroke-dasharray",k+" "+k).attr("stroke-dashoffset",k).transition().duration(10*k).ease("quad-in-out").attr("stroke-dashoffset",0).each("end",d),i.append("circle").attr("r",12).attr("cx",h.origin[0]).attr("cy",h.origin[1]).attr("fill",h.color),i.append("text").attr("x",h.origin[0]).attr("y",h.origin[1]+3).attr("font-size",10).attr("fill","black").attr("text-anchor","middle").text(h.day+1),h.length=k}return a},b(a),this.draw(this.mapData())}function Line(a,b,c,d,e){a.append("line").attr("x1",b[0]).attr("y1",b[1]).attr("x2",c[0]).attr("y2",c[1]).attr("stroke",d?d:"black").attr("stroke-width",e?e:1)}function rad(a){return a*(Math.PI/180)}function deg(a){return a*(180/Math.PI)}function slope(a,b){var c=a[0],d=b[0],e=a[1],f=b[1],g=(f-e)/(d-c);return g}function projectPoint(a,b,c){c+=90;var d=a[0],e=a[1],f=d-Math.cos(rad(c))*b,g=e-Math.sin(rad(c))*b;return[Math.round(100*f)/100,Math.round(100*g)/100]}var Event={HILITE:function(){var a=d3.select(this.parentNode);console.log(a)}};Date.prototype.getMonthName=function(){var a=["January","February","March","April","May","June","July","August","September","October","November","December"];return a[this.getMonth()]};